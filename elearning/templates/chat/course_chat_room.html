{% extends 'base.html' %}
{% block content %}
<div class="card">
    <h2>Course Chat Room - {{ course.title }}</h2>
    <div id="chat-log" class="chat-log">
    {% for msg in chat_history %}
        <p>
            <strong>
            <a href="{% url 'accounts:public_profile' msg.sender.username %}">
                {{ msg.sender.username }}
            </a>:
            </strong>
            {{ msg.message }}
            <small>({{ msg.timestamp|date:"H:i" }})</small>
        </p>
    {% endfor %}
    </div>
    <div class="chat-input">
        <input id="chat-message-input" type="text" placeholder="Type your message here..." size="80">
        <button id="chat-message-submit" class="btn">Send</button>
    </div>
</div>
<script>
    const courseId = "{{ course.id }}";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/course_chat/' + courseId + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.getElementById('chat-log');
        const message = '<p><strong>' + data.username + ':</strong> ' + data.message + '</p>';
        chatLog.innerHTML += message;
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('chat-message-submit').onclick = function(e) {
        const messageInputDom = document.getElementById('chat-message-input');
        const message = messageInputDom.value;
        if(message.trim() !== "") {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        }
    };
</script>
{% endblock %}
